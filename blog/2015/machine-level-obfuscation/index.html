<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>Aseem  Baranwal | Machine level obfuscation</title>
<meta name="description" content="PhD student at Cheriton School of Computer Science @UWaterloo.
">

<!-- Open Graph -->


<!-- Bootstrap & MDB -->
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" integrity="sha512-MoRNloxbStBcD8z3M/2BmnT+rg4IsMxPkXaGh2zD6LGNNFE80W3onsAhRcMAMrSoyWL9xD7Ert0men7vR8LUZg==" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/css/mdb.min.css" integrity="sha512-RO38pBRxYH3SoOprtPTD86JFOclM51/XTIdEPh5j8sj4tp8jmQIx26twG52UaLi//hQldfrh7e51WzP9wuP32Q==" crossorigin="anonymous" />

<!-- Fonts & Icons -->
<script src="https://kit.fontawesome.com/51a68d8c36.js" crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.0/css/academicons.min.css" integrity="sha512-W4yqoT1+8NLkinBLBZko+dFB2ZbHsYLDdr50VElllRcNt2Q4/GSs6u71UHKxB7S6JEMCp5Ve4xjh3eGQl/HRvg==" crossorigin="anonymous">
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons">

<!-- Code Syntax Highlighting -->
<link rel="stylesheet" href="https://gitcdn.link/repo/jwarby/jekyll-pygments-themes/master/github.css" />

<!-- Styles -->
<link rel="shortcut icon" href="/assets/img/favicon.ico">
<link rel="stylesheet" href="/assets/css/main.css">

<link rel="canonical" href="/blog/2015/machine-level-obfuscation/">

<!-- JQuery -->
<!-- jQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>


<!-- Theming-->

    
<!-- MathJax -->
<script type="text/javascript">
  window.MathJax = {
    tex: {
      tags: 'ams'
    }
  };
</script>
<script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-mml-chtml.js"></script>
<script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>


  </head>

  <body class="fixed-top-nav sticky-bottom-footer">

    <!-- Header -->

    <header>

    <!-- Nav Bar -->
    <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top">
    <div class="container">
      <a class="navbar-brand title font-weight-lighter" href="/">
       <span class="font-weight-bold">Aseem</span>   Baranwal
      </a>
      <!-- Navbar Toggle -->
      <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar top-bar"></span>
        <span class="icon-bar middle-bar"></span>
        <span class="icon-bar bottom-bar"></span>
      </button>
      <div class="collapse navbar-collapse text-right" id="navbarNav">
        <ul class="navbar-nav ml-auto flex-nowrap">
          <!-- About -->
          <li class="nav-item ">
            <a class="nav-link" href="/">
              about
              
            </a>
          </li>
          <!-- Other pages -->
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/publications/">
                publications
                
              </a>
          </li>
          
          
          
          <!-- Blog -->
          <!-- <li class="nav-item active">
            <a class="nav-link" href="/blog/">
              blog
              
            </a>
          </li> -->
          
          
        </ul>
      </div>
    </div>
  </nav>

</header>


    <!-- Content -->

    <div class="container mt-5" style="text-align:justify;">
      

<div class="post">

  <header class="post-header">
    <h1 class="post-title">Machine level obfuscation</h1>
    <p class="post-meta">January 25, 2015 • Aseem</p>
  </header>

  <article class="post-content">
    <p>Let’s start with this small C program. What do you think it does?</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="cp">#include &lt;stdio.h&gt;
</span><span class="kt">double</span> <span class="n">d</span><span class="p">[]</span><span class="o">=</span> <span class="p">{</span><span class="mi">1156563417652693958656</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span> <span class="mi">272</span><span class="p">};</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">--?</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*=</span><span class="mi">2</span><span class="p">,</span> <span class="n">main</span><span class="p">()</span> <span class="o">:</span> <span class="n">printf</span><span class="p">(</span><span class="s">"%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">d</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Go ahead and run it on your machine. For lazy bums, you can see the output <a href="http://ideone.com/UaGZDp">here</a>. Well, the output of this code depends on the machine, more specifically the <a href="http://en.wikipedia.org/wiki/Endianness">endianness</a> of the machine. Let us walk through the code line by line to understand what is happening.</p>

<h2 id="line-2">Line 2</h2>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kt">double</span> <span class="n">d</span><span class="p">[]</span><span class="o">=</span> <span class="p">{</span><span class="mi">1156563417652693958656</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span> <span class="mi">272</span><span class="p">};</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Here we have simply declared a one-dimensional double array and initialized it with two elements with some values. The numbers are specific, which we shall see later in this post.</p>

<h2 id="line-5">Line 5</h2>
<p>This line is a fancy way of saying</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="k">if</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">main</span><span class="p">();</span>
<span class="p">}</span>
<span class="k">else</span>
<span class="p">{</span>
    <span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">d</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Ternary operators are used here instead of an if-else block to condense the code. The main function is called repeatedly until <code class="language-plaintext highlighter-rouge">d[1]</code> becomes 0. Then we typecast the <code class="language-plaintext highlighter-rouge">double</code> array to a <code class="language-plaintext highlighter-rouge">char</code> pointer and print its value as a string using the <code class="language-plaintext highlighter-rouge">"%s"</code> placeholder in the <code class="language-plaintext highlighter-rouge">printf</code> function.</p>

<p>So when does <code class="language-plaintext highlighter-rouge">d[1]</code> become 0? You got it right, it’s after doubling <code class="language-plaintext highlighter-rouge">d[0]</code> 272 times. Now when <code class="language-plaintext highlighter-rouge">d[1]</code> becomes 0, <strong><code class="language-plaintext highlighter-rouge">d[0] = 8.77663973968813359063877158122E102</code></strong> in the <em><strong>mantissa exponent</strong></em> notation. This 64 bit double number in binary is represented as:
<strong>01010101 01001111 01011001 01000101 01010110 01001111 01001100 01001001</strong></p>

<p>These are the 8 bytes (64 bits) representing the number. Here the first bit 0 denotes the sign (+ve) of the number. The next 11 bits <strong>10101010100</strong> represent the <strong>exponent</strong>, and the last 52 bits <strong>1111 0101 1001 0100 0101 0101 0110 0100 1111 0100 1100 0100 1001</strong> represent the <strong>mantissa</strong>.</p>

<p>This is an 8-byte representation (64 bits) in the IEEE754 standard and so a char pointer will read the whole thing one byte at a time, as char is 1-byte in size in the C language implementation. Now comes the role of endianness. On little endian machines, the string will be read backwards, i.e. the last byte is read first, so the bytes read in order are (binary, hex, decimal, char ascii):</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">01001001 = 0x49 = 73 = I</code></li>
  <li><code class="language-plaintext highlighter-rouge">01001100 = 0x4C = 76 = L</code></li>
  <li><code class="language-plaintext highlighter-rouge">01001111 = 0x4F = 79 = O</code></li>
  <li><code class="language-plaintext highlighter-rouge">01010110 = 0x56 = 86 = V</code></li>
  <li><code class="language-plaintext highlighter-rouge">01000101 = 0x45 = 69 = E</code></li>
  <li><code class="language-plaintext highlighter-rouge">01011001 = 0x59 = 89 = Y</code></li>
  <li><code class="language-plaintext highlighter-rouge">01001111 = 0x4F = 79 = O</code></li>
  <li><code class="language-plaintext highlighter-rouge">01010101 = 0x55 = 85 = U</code></li>
</ul>

<p>As <code class="language-plaintext highlighter-rouge">d[]</code> is an array, the next byte after <code class="language-plaintext highlighter-rouge">d[0]</code> in memory stores <code class="language-plaintext highlighter-rouge">d[1]</code> which is now <code class="language-plaintext highlighter-rouge">= -1.0</code>; so the last byte is <code class="language-plaintext highlighter-rouge">0000</code> which acts as a <code class="language-plaintext highlighter-rouge">NULL</code> character, terminating the string for the <code class="language-plaintext highlighter-rouge">%s</code> placeholder in <code class="language-plaintext highlighter-rouge">printf</code>. Hence, the output of the code above is <code class="language-plaintext highlighter-rouge">ILOVEYOU</code>.</p>

<p>Interesting, isn’t it? You just found a geeky way to say this to the love of your life! Anyway, this interesting aspect can be used to obfuscate any string into numbers, as I did with my name. <code class="language-plaintext highlighter-rouge">ASEEMRAJ</code> can be obfuscated with <code class="language-plaintext highlighter-rouge">d[0] = 4875566432211777.0</code> and <code class="language-plaintext highlighter-rouge">d[1] = 113</code>. Now go and find the magical numbers for your own strings.</p>

<p><em>Note: If a <code class="language-plaintext highlighter-rouge">float</code> is used instead of double we have 4 bytes, hence 4 characters instead of 8.</em></p>

  </article>

  

</div>

    </div>

  </body>

  <!-- Bootsrap & MDB scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.4.4/umd/popper.min.js" integrity="sha512-eUQ9hGdLjBjY3F41CScH3UX+4JDSI9zXeroz7hJ+RteoCaY+GP/LDoM8AO+Pt+DRFw3nXqsjh9Zsts8hnYv8/A==" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha512-M5KW3ztuIICmVIhjSqXe01oV2bpe248gOxqmlcYrEzAvws7Pw3z6BK0iGbrwvdrUQUhi3eXgtxp5I8PDo9YfjQ==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/js/mdb.min.js" integrity="sha512-Mug9KHKmroQFMLm93zGrjhibM2z2Obg9l6qFG2qKjXEXkMp/VDkI4uju9m4QKPjWSwQ6O2qzZEnJDEeCw0Blcw==" crossorigin="anonymous"></script>

  
<!-- Mansory & imagesLoaded -->
<script defer src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
<script defer src="https://unpkg.com/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
<script defer src="/assets/js/mansory.js" type="text/javascript"></script>


  


<!-- Load Common JS -->
<script src="/assets/js/common.js"></script>


  <br>
</html>
